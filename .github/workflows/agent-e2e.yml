name: Agent E2E Test

on:
  push:
    paths:
      - 'packages/starknet/skills/**'
  pull_request:
    paths:
      - 'packages/starknet/skills/**'

jobs:
  zero-knowledge-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install -g @anthropic-ai/sdk starknet
          
      - name: Run Zero-Knowledge Agent Test
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          STARKNET_RPC_URL: https://starknet-sepolia.public.blastapi.io
        run: |
          cat > agent_test.js << 'TESTEOF'
          const Anthropic = require("@anthropic-ai/sdk");
          const fs = require("fs");
          
          const client = new Anthropic({
            apiKey: process.env.ANTHROPIC_API_KEY,
          });
          
          async function testAgentOnboarding() {
            const skill = fs.readFileSync(
              "packages/starknet/skills/onboard/SKILL.md",
              "utf-8"
            );
            
            const message = await client.messages.create({
              model: "claude-3-5-sonnet-20241022",
              max_tokens: 4096,
              messages: [{
                role: "user",
                content: `You are a fresh AI agent who has NEVER used Starknet before.

Your ONLY source of information is this skill guide:

${skill}

Task: Follow the guide EXACTLY to onboard to Starknet Sepolia and register with Huginn.

Report:
1. Did the skill provide ALL necessary information?
2. Were any steps ambiguous or missing?
3. Could you complete the task successfully?
4. What would improve the skill?`
              }]
            });
            
            console.log(message.content[0].text);
            
            const response = message.content[0].text.toLowerCase();
            if (response.includes("successfully") || response.includes("completed")) {
              console.log("âœ… Agent test PASSED");
              process.exit(0);
            } else {
              console.log("âŒ Agent test FAILED");
              process.exit(1);
            }
          }
          
          testAgentOnboarding();
          TESTEOF
          
          node agent_test.js

      - name: Validate Skill Completeness
        run: |
          # Check that SKILL.md contains required sections
          grep -q "Prerequisites" packages/starknet/skills/onboard/SKILL.md
          grep -q "Step 1:" packages/starknet/skills/onboard/SKILL.md
          grep -q "Quick Start" packages/starknet/skills/onboard/SKILL.md
          echo "âœ… Skill structure validated"
